# ftime v0.1.0 仕様書（日本語版・詳細）

本ドキュメントは `docs/SPEC-v0.1.md` の日本語拡張版です。原文の要件を忠実に写しつつ、実装上の意図・背景・具体例・制約事項を補足し、初学者でも迷わないようにします。v0.1 のスコープに限定し、将来拡張（Git連携等）は参考情報として別節にまとめます。

---

## 1. スコープと目的
- **対象**: ローカルファイルシステム上のディレクトリ直下（深さ1）の内容を、最終更新時刻（mtime）に基づいて可視化する読み取り専用CLIツール。
- **ユースケース例**:
  - 直近編集したファイルやディレクトリをすぐ開きたいときの短期作業履歴ビュー。
  - 日次スタンドアップや振り返りで「今日どのファイルを触ったか」を即座に確認。
  - リダイレクトやパイプで他ツールへ渡し、スクリプトの前処理にする。
- **非対象**:
  - Git連携による変更種別表示（planned v0.2以降）。
  - 再帰的ディレクトリ走査（パフォーマンスと意図的なシンプルさのため v0.1 では未対応）。
  - タグ付けやヒューリスティックによる由来判定（Fresh/Imported分類などは将来案）。

## 2. 入力モデル
- **対象ディレクトリ**: コマンド引数 `[PATH]` で指定。省略時は現在の作業ディレクトリ `.`。
- **検査前提**: ルートのパスが存在し、かつディレクトリであることを確認する。ファイルを渡した場合はエラー終了（コード1）。
- **エントリ収集**:
  - `std::fs::read_dir` を使用し、深さ1のみを列挙（サブディレクトリ内は探索しない）。
  - シンボリックリンク: `lstat` の結果を用い、リンク自身のメタデータ（サイズ・パーミッション・mtime）を採用する。リンク先へは追従しないが、表示用には `read_link` 成功時のパスを記録。
  - 壊れたリンク: 読み取りエラーが出てもパニックさせず、リンク文字列を表示する（ターゲット解決に失敗した場合は `<unresolved>` と出力）。
  - パーミッションエラー: そのエントリをスキップして処理継続（必要なら将来 `--verbose` で警告表示を検討）。
  - 隠しファイル: 先頭が `.` の名前はデフォルト除外。`-H/--hidden` で含める。
  - デフォルト除外: `.DS_Store`, `Thumbs.db`（`--hidden` でも除外）

## 3. 時間バケット分類
**評価順序は固定**: Active → Today → This Week → History。早くマッチしたものを採用する。

| バケット名 | 条件（ローカル時間基準） | 典型表示例 |
| --- | --- | --- |
| 🔥 Active Context | `now - mtime < 1時間` | `main.rs 12 mins ago` |
| ☕ Today's Session | `mtime >= 今日 00:00:00` | `notes.md 3 hours ago` |
| 📅 This Week | `now - mtime < 7日` | `report.pdf 3 days ago` |
| 💤 History | 上記以外 | `archive.zip 2024-11-02` |

- **未来時刻**: システム時計のずれ等で未来になっている場合も Active に入れる（作業中ファイルを見逃さないため）。
- **バケット表示上限**: 1バケット最大20件。21件以上ある場合は上位20件を表示し、末尾に `... and N more items` を付ける。History折り畳みと組み合わせることで大量件数でも高速。
- **空バケット**: 見出し行は出さない。全体で0件なら `No recent files found` を出力して終了。

### 相対時間表示ルール
- 0–59秒: `just now`
- 1分ちょうど: `1 min ago`
- 2–59分: `{N} mins ago`
- 1時間: `1 hour ago`
- 2–23時間: `{N} hours ago`
- 1日: `Yesterday`
- 2–6日: `{N} days ago`
- 7日以上: `YYYY-MM-DD`（ローカル日付）

## 4. ソート戦略
1. 収集したすべての有効エントリを `mtime` 降順でソート。
2. ソート順を保ったまま各バケットに分配。
3. 各バケット内はもとのソート順を維持（追加ソートなし）。結果、全体として時間順のままバケット表示される。

## 5. 出力形式（TTYモード）
- **ヘッダー**: バケットごとにアイコン＋名称を太字で表示。例 `🔥 Active Context (< 1h)`。
- **エントリ行**: `"  • {名前}  {相対時間}"`。  
  - ディレクトリ: 末尾に `/` を付け Bold Blue。  
  - シンボリックリンク: 本体名を Yellow、`->` 以降のターゲットを dimmed。解決失敗時は `<unresolved>`。ターゲットはベースディレクトリからの相対表示を試みる。  
  - 通常ファイル: 色付けなし（NO_COLOR 時は全て無色）。  
- **History の折り畳み**: `--all` なしの場合は `💤 History (N files hidden)` の1行のみ。`--all` でリスト表示＋必要なら `... and N more items` を付加。
- **カラー抑止**: 環境変数 `NO_COLOR` 設定時は常に無色。オプションフラグは不要。
- **強制TTY**: `FTIME_FORCE_TTY` が設定されている場合、stdout がパイプでもTTYスタイルを使う（テストやデモ用途）。

## 6. 出力形式（パイプ/非TTY）
- カラー・アイコン・バケットヘッダーなし。
- 全件をタブ区切り1行1エントリで出力: `<path>\t<relative_time>`。
- 20件上限制限なし。ヒストリ折り畳みなし。
- ソート順はTTYと同じ（mtime降順）。

## 7. フィルタリング
- 隠しファイル: デフォルト除外。`-H/--hidden` で含める。
- 拡張子フィルタ: `--ext rs,toml` のようにカンマ区切りでホワイトリスト（大文字小文字無視）。対象はファイルのみ。ディレクトリと拡張子なしファイルは除外される。

## 8. 環境変数
- `NO_COLOR`: 設定されていればカラー無効。値は問わない。
- `FTIME_FORCE_TTY`: 設定されていればTTYスタイルを強制。CIやスナップショットテストで便利。

## 9. エラーと終了コード
- 0: 正常終了。
- 1: ルートパスが存在しない／ディレクトリでない／メタデータ取得不能などの一般エラー。
- エントリ単位の権限エラーは無視して継続（ツール全体は成功扱い）。

## 10. 性能と制約
- 深さ1限定によりI/O量を抑制し、2000件程度でも即時応答を想定。
- 再帰や大規模ウォークは非対応。必要なら別ツールを併用するか将来版を検討。
- 追加依存は `clap` `colored` `chrono` `is-terminal` `anyhow` のみ。シンプルで移植性を重視。

## 11. 既知の限界と将来拡張案
- Gitメタデータ表示（新規・変更・削除など）をv0.2以降で検討。
- バケット境界のローカルタイム依存によるタイムゾーン跨ぎ挙動は現仕様では未解決（旅行・DST変更時は注意）。
- テーマカラーのカスタマイズ、出力フォーマット指定（JSON/CSV）は現状非対応。

## 12. 参考例
- **隠しファイル除外のまま実行**: `ftime ~/workspace`  
  出力に `.git` は含まれない。
- **履歴全展開**: `ftime -a`  
  History も上位20件＋残数表示。1000件でも応答は一定。
- **パイプ利用**: `ftime | fzf`  
  タブ区切りで渡せるため、`cut -f1` でパスだけ抽出も容易。

## 13. メタ認知メモ
- ユーザーは「直近に触れたファイルを素早く見つけたい」という動機が中心。バケットと相対時間はそのための最短ルート。
- 過剰な機能追加はUXを複雑にするため、v0.1は最小限の操作・依存・出力に絞る。
- NO_COLOR / FORCE_TTY はテスト容易性と環境適応性を両立するスイッチとして重要。

## 14. シナリオ別詳細例
### 14.1 デイリー振り返り
- 朝一で `ftime -a` を実行し、前日の作業を History まで展開。`Yesterday` が含まれる Today/History 境界の挙動を自然に確認できる。
- 隠しファイルを含めたい場合は `ftime -a -H`。`.env` や `.gitignore` も表示されるので、機密情報の視認に注意。

### 14.2 リダイレクト活用
- `ftime | sort` のような二重ソートは意味がない（すでに mtime 降順）。代わりに `cut -f1` でパスだけ抽出し、`xargs -r ls -l` で詳細を見る、といったパイプが実用的。
- `FTIME_FORCE_TTY=1 ftime | sed -n '1,5p'` とすればTTYフォーマットをパイプで確認でき、スナップショットテストに便利。

### 14.3 CIでの利用
- CI環境は非TTYが多い。`FTIME_FORCE_TTY` をセットするとテキストスナップショットが変わるため、ジョブごとに統一する。
- `NO_COLOR=1` で色を抑止しておくとログ検索しやすい。

### 14.4 大量ファイルがある場合
- 1バケット20件上限のおかげでTTY出力は常に一定量に収まる。Historyが1万件あっても折り畳み1行＋トップ20件のみ。
- パイプモードでは上限が外れるため、必要なら `head -n 200` 等で外部制限をかける。

## 15. エラーケースとユーザーメッセージ
| 状況 | 表示 | 終了コード | 備考 |
| --- | --- | --- | --- |
| ルートが存在しない/ファイル | `X is not a directory` | 1 | clapの引数パース後、metadataチェックで検出 |
| read_dir失敗（権限等） | `failed to read directory ...` | 1 | `anyhow` で文脈付き |
| 個別エントリのmetadata/mtime取得失敗 | 無表示 | 0 | そのエントリのみスキップ |
| 全エントリスキップ | `No recent files found` | 0 | 隠しファイルのみのディレクトリ等 |

## 16. 互換性・プラットフォーム
- 対応OS: POSIX互換を前提に設計（Linux/macOS）。`std::fs::read_dir` が動作する環境ならWindowsでもビルド可能だが、シンボリックリンクの扱いと色コードは環境依存。
- タイムゾーン: `chrono::Local` に依存。システム設定に左右されるため、UTC固定が必要な場面は別ツールで前処理する。
- 文字コード: ファイル名はOS文字列をロスなく保持するため`OsString`→`to_string_lossy`で表示している。不可逆変換が起きる可能性があるが、表示優先とする。

## 17. 他ツールとの連携パターン
- `fzf` 連携: `ftime | fzf --with-nth=1` でパス選択、Enter後 `xdg-open` などへパイプ可能。
- `entr` との併用: `ftime | cut -f1 | entr -p echo reload` のような使い方は推奨しない（非再帰で変化検知は限定的なため）。
- `make` や `just` のレシピに組み込み、`make recent` として開発開始のルーチンに入れるとチームで再現性が高まる。

## 18. FAQ（利用者視点のよくある疑問）
- **Q: 再帰しない理由は？**  
  A: 大規模ツリーでのパフォーマンス確保と、直近作業コンテキストに絞る意図のため。再帰が欲しい場合は `find` などと組み合わせるか将来版を待つ。
- **Q: mtime以外（atime/btime）を使えない？**  
  A: v0.1はmtime固定。btimeはプラットフォーム差が大きく、仕様を安定させるため採用していない。
- **Q: 20件制限を変更したい**  
  A: CLIオプションは未提供。設計上は一定の情報量を保つため固定値。forkして変更する場合はテスト更新が必要。
- **Q: 色が見づらい**  
  A: `NO_COLOR=1` で無色にするか、パイプモードを利用。現行はテーマ変更を提供しない。
- **Q: ファイル名にタブが含まれると？**  
  A: パイプ出力はタブ区切りのため解析しづらくなる。TTY表示では視覚的に問題ない。必要なら `tr '\t' ' '` 等で前処理。

## 19. トラブルシューティング
- **何も表示されない**: 実ディレクトリが空、または全て隠しファイルの場合。`-H` を試す。`ls -a` で内容を確認。
- **Historyだけ多すぎて把握できない**: デフォルトでは折り畳まれている。`-a` で展開し、`head -n` で絞る。
- **タイムゾーンが合わない**: `date` コマンドでシステム時刻を確認。Dockerコンテナ等でTZが異なる場合は環境変数`TZ`を設定する。
- **シンボリックリンクが `<unresolved>` になる**: リンク切れか、権限不足の可能性。`ls -l` でターゲットを確認。

## 20. 将来版へのヒント（メタ）
- Git連携を入れる場合は `FileEntry` に `git_status` を追加し、ビュー層で色分けを行うと拡張しやすい。現在のバケットロジックはそのまま流用できる。
- JSON/CSV出力を追加する場合、パイプモードのフォーマットを壊さないよう `--format json` のような明示オプションにするのが安全。
- 20件上限の可変化を行うなら、TTY表示の行数が増え過ぎないよう、デフォルト値を維持しつつ `--limit` オプションで上書き可能にする案がある。

## 21. 入力検証フロー（擬似コード）
```
parse CLI -> path = arg or cwd
if !exists(path) || !is_dir(path): exit 1 with message
if NO_COLOR set: disable color globally
entries = []
for dir_entry in read_dir(path):
    if !include_hidden && name starts_with '.': continue
    meta = symlink_metadata(dir_entry) or continue
    mtime = meta.modified() or continue
    push FileEntry { path, name, is_dir, mtime, is_symlink, symlink_target=read_link_ok }
sort entries by mtime desc
bucketed = bucketize(entries, now)
if FORCE_TTY or stdout.is_terminal(): render_tty(bucketed, now, path, show_all_history)
else: render_text(entries, now, path)
```

## 22. 相対時間の追加例（境界試験の指針）
- 59秒: `just now`
- 60秒: `1 min ago`
- 61秒: `1 min ago`（丸めなし）
- 119秒: `1 min ago`
- 120秒: `2 mins ago`
- 3599秒: `59 mins ago`
- 3600秒: `1 hour ago`
- 86399秒: `23 hours ago`
- 86400秒: `Yesterday`
- 172799秒: `1 days ago` ではなく `Yesterday` のまま（仕様上1日のみ特別扱い）
- 172800秒: `2 days ago`
- 604800秒: `YYYY-MM-DD` 表示へ切替

## 23. 用語集
- **mtime**: 最終更新時刻。POSIX stat 構造体の `st_mtime` に相当。
- **TTY**: 端末（ターミナルデバイス）を指す。`stdout.is_terminal()` が true ならTTYモード。
- **隠しファイル**: 先頭が `.` のファイル/ディレクトリ。Unix慣習に従う。
- **シンボリックリンク**: ファイルシステム上の参照。リンク自体のメタデータを用いる点に注意。

## 24. 変更履歴（この日本語版）
- 2025-12-10: 初版作成。原文に加え、利用シナリオ・FAQ・エラー表・擬似コード等を大幅拡張。

（本文は原文より詳細化しており、実装・テストと矛盾しないよう随時アップデートすること。）
