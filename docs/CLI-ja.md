# ftime CLI 契約（日本語版・詳細）

本書は `docs/CLI.md` を日本語で拡充したものです。コマンドの書式、オプションや環境変数の意味、出力例、利用シナリオ別の使い方、トラブルシューティングを7000文字超でまとめています。仕様の根拠は `SPEC-v1.0.md` / `SPEC-ja.md` にあり、本書はユーザーが迷わず使うための実践ガイドです。

---

## 1. コマンド署名
```
ftime [OPTIONS] [PATH]
```
- `PATH` を省略するとカレントディレクトリ `.` を走査。
- 引数は1つのみ。複数指定はv1.0では未サポート（最初の1つだけ読む仕様は採用していない）。

## 2. オプション一覧と詳細
| 短 | 長 | 説明 | 使いどころ |
| --- | --- | --- | --- |
| `-a` | `--all` | History バケットを折り畳まず全表示（ただし各バケット20件上限は維持）。 | 昨日以前の作業を俯瞰したいとき |
|  | `--json` | JSON Lines出力（1行1オブジェクト、固定フィールド、色/上限なし）。 | 機械処理したいとき |
|  | `--ext` | 拡張子ホワイトリスト（カンマ区切り・大文字小文字無視）。ファイルのみ対象、ディレクトリ/拡張子なしは除外。 | 特定言語のファイルだけ見たいとき（例: `--ext rs,toml`） |
| `-H` | `--hidden` | ドットファイルを含める | `.env` や `.gitignore` も確認したいとき |
|  | `--no-ignore` | デフォルト / `~/.ftimeignore` を無効化 | ignoreが効いているか確認したいとき |
|  | `--no-labels` | Fresh などのラベル表示を無効化 | ラベルが不要なとき |
| `-h` | `--help` | ヘルプを表示して終了 | オプション確認 |
| `-V` | `--version` | バージョン表示 | 動作確認・バグ報告用 |
|  | `--icons` | Nerd Fontアイコンを表示（`--features icons` ビルド時）。未ビルドでもエラーにせず無視（no-op）。 | アイコン付きで視覚的に見たい |

### オプションの組み合わせ例
- `ftime -a -H ~/project` : 隠しファイル込み、History展開で全容把握。
- `ftime --hidden` : ショート無しの指定も可能。
- `ftime -a` をパイプに流すと、非TTYではカラーなし全件リストになる点に注意（上限も外れる）。

## 3. 環境変数
- `NO_COLOR`: 値を問わず（空文字も含む）設定されていればカラーを完全無効化。TTYでも無色になる。
- `FTIME_FORCE_TTY`: 設定されていれば、stdout がパイプでもTTYフォーマット（バケット＋アイコン）を強制。スナップショットテストやデモ用途で便利。
- `FTIME_IGNORE`: グローバル ignore ファイルのパスを上書き（デフォルトは `~/.ftimeignore`）。`#` でコメント、空行は無視、簡易グロブ1行1パターン。
- 両方設定した場合: TTYフォーマットだが色は付かない、という組み合わせになる。

## 4. 終了コード
- `0`: 正常終了。権限不足で一部を読み飛ばしてもツール全体は成功扱い。
- `1`: パスが存在しない、ディレクトリでない、`read_dir` 不能など致命的エラー。
- それ以外のコードは現時点では使用しない。

## 5. 基本の使い方
まず `ftime` コマンドを実行できる状態にします（初回のみ）。

```
# リポジトリ内で使う場合
./target/release/ftime

# どのディレクトリでも `ftime` だけで使いたい場合
cargo install --path .
```

- `cargo install --path .` のインストール先は既定で `~/.cargo/bin`（Windowsは `%USERPROFILE%\.cargo\bin`）。
- そのディレクトリが PATH に通っていれば `ftime` だけで実行可能。

### 5.1 何も付けずに実行
```
ftime
```
- カレントディレクトリを走査し、TTYならバケット表示。隠しファイルは出ない。Historyは折り畳まれる。

### 5.2 ディレクトリを指定
```
ftime ~/Downloads
```
- 直下のみが対象。サブフォルダ内までは潜らない。

### 5.3 隠しファイルを含める
```
ftime -H
```
- `.git` や `.env` を表示したいとき。情報量が増えるので必要時のみ。

### 5.4 Historyを展開
```
ftime -a
```
- 7日より古いファイルも一覧表示。20件超は `... and N more items` が付く。

### 5.5 パイプで加工
```
ftime | cut -f1 | head
```
- 非TTYなのでタブ区切りプレーンテキストで全件出力。上限なし。`cut` でパスだけ取り出すのに適する。

## 6. 出力例
### 6.1 TTY（カラー有り）
```
🔥 Active Context (< 1h)
  • src/main.rs  12 mins ago
  • README.md  just now

☕ Today's Session
  • docs/notes.md  3 hours ago

📅 This Week
  • scripts/cleanup.sh  2 days ago

💤 History (25 files hidden)
```

### 6.2 TTY（カラーなし: NO_COLOR=1）
```
🔥 Active Context (< 1h)
  • src/main.rs  12 mins ago
...
```

### 6.3 パイプ（非TTY）
```
src/main.rs\t12 mins ago
docs/notes.md\t3 hours ago
scripts/cleanup.sh\t2024-11-02
```

### 6.4 JSON Lines
```
{"path":"src/main.rs","bucket":"active","mtime":"2025-12-10T12:00:00Z","relative_time":"just now","is_dir":false,"is_symlink":false,"label":"fresh"}
```

## 7. バケットと相対時間の要点（使用者向け）
- Active: 直近1時間未満。未来時刻もここに入る。
- Today: ローカル日付の00:00以降。タイムゾーン依存なので、リモート環境ではTZに注意。
- This Week: 7日未満。境界をまたいだ場合の優先順は Active → Today → Week → History。
- History: それ以外。TTYでは折り畳みがデフォルト。
- 相対時間は英語固定。60秒未満は `just now`、1分きっかりは `1 min ago`。

## 8. シナリオ別ガイド
### 8.1 朝一で作業再開
- コマンド: `ftime`  
- 直近1時間と今日の更新だけ見れば十分。Historyは折り畳まれてノイズが少ない。

### 8.2 昨日の作業確認
- コマンド: `ftime -a`  
- 昨日が History に落ちている場合があるので展開。件数が多ければ `... and N more items` で把握。

### 8.3 dotfiles変更をチェック
- コマンド: `ftime -H -a`  
- 設定ファイル `.zshrc` などの更新を漏らさない。情報量増に注意。

### 8.4 パイプで別ツールに渡す
- コマンド: `ftime | fzf`  
- タブ区切り2列のため `fzf --with-nth=1` でパスのみを表示できる。

### 8.5 CIログで確認
- コマンド: `NO_COLOR=1 ftime` または `FTIME_FORCE_TTY=1 ftime`  
- 色なし/TTY強制で決定論的な出力を得られ、スナップショット比較が容易。

## 9. エラー時の挙動
- ルートがファイル: `X is not a directory` をstderrに表示し終了コード1。
- `read_dir` 失敗: `failed to read directory ...` と表示し終了コード1。
- 個別エントリの権限エラー: そのエントリをスキップし続行。ユーザーへの通知はデフォルトなし。
- 何も出力されないケース: ディレクトリが空、または全て隠しファイルで `-H` なし → `No recent files found` を表示し終了コード0。

## 10. TIPS（使いこなしの小技）
- `alias fr='ftime -a -H'` のようにエイリアス化すると再開が速い。
- `ftime | head -n 5` で上位5件だけクイックチェック。
- `ftime -a | sed -n '1,40p'` でTTY表示を40行だけ覗く（FTIME_FORCE_TTYを併用）。
- `ftime | grep '.rs\t'` のように拡張子フィルタをパイプで後段処理。

## 11. よくある質問（FAQ）
- **Q: 再帰はできますか？**  
  A: v1.0では深さ1のみ。大量ディレクトリでも高速を保つための意図的制限です。
- **Q: 20件以上見たい**  
  A: TTY表示は各バケット20件に固定。パイプ出力なら全件出るので `ftime | less` を推奨。
- **Q: 色が出ない**  
  A: `NO_COLOR` が設定されていないか確認。Windowsの旧端末ではANSIが無効な場合があります。
- **Q: ファイル名にタブが入っていると？**  
  A: パイプ出力の区切りと衝突するため解析が難しくなります。`tr '\t' ' '` などで置換してください。
- **Q: 未来時刻のファイルはどこに？**  
  A: Active に入ります。システム時計のズレが疑われる場合は時刻設定を確認してください。

## 12. トラブルシューティング
- **何も表示されない**: ディレクトリが空、または隠しファイルのみかも。`-H` で再実行。
- **Historyが長すぎる**: デフォルト折り畳みのままにし、必要に応じ `-a` + `head` で絞る。
- **CIで色が混ざる**: `NO_COLOR=1` をセットする。
- **文字化け**: `to_string_lossy` による置換が起きている可能性。表示専用なのでファイル自体は壊れない。

## 13. 出力フォーマット詳細
- TTY:  
  - 行頭2スペース＋中点 `•` を使用。`NO_COLOR` 時も同じ記号を維持し、構造を崩さない。  
  - バケット間に空行を1つ挿入。  
  - ディレクトリは末尾 `/`、シンボリックリンクは `name -> target`。  
- 非TTY:  
  - `<相対パス>\t<相対時間>` の2カラム。  
  - パスはベースディレクトリからの相対を試み、失敗時はファイル名のまま。  
  - 改行コードはLF固定。  

## 14. テスト観点とCLIの関係
- `tests/cli.rs` では以下を確認済み:  
  - ルートがファイルの場合のエラー終了  
  - 隠しファイルの除外/包含  
  - History折り畳みと `... and N more items` 表示  
  - パイプ時のタブ区切り & ヘッダなし  
- ユーザーがカスタム環境変数を設定しても、上記仕様を壊さないことが前提。

## 15. CI/自動化での推奨フラグ
- `NO_COLOR=1` : ログの可読性向上。
- `FTIME_FORCE_TTY=1` : TTY書式を固定し、スナップショットテストで比較しやすくする。
- `ftime -a -H` : 包括的に出力したい場合。ただし大量出力になるため `head` などで制限を。

## 16. バージョンポリシー
- v1.0 はCLIインターフェースを凍結するフェーズ。互換性を重視し、オプション追加時は後方互換に配慮する。
- メジャーアップ時は `--all` など既存フラグの動作変更を避けるか、非推奨段階を設ける。
- CLIや出力フォーマットの変更はメジャーアップデートに限定する。
- v1.0 時点で Experimental なオプションは存在しない（将来追加時は明記する）。
- 重要フラグ（`--all`, `--hidden`, `--json`）の挙動は凍結。色は `NO_COLOR` で制御し、`--no-color` フラグは存在しない。

## 17. 例外・非対応事項
- 複数パス同時指定、グロブ展開、正規表現フィルタは未サポート。
- 出力言語の切替、時刻フォーマットのカスタマイズ、ページング機能は未提供。
- 標準入力からのパス読み込みは行わない（常にファイルシステムを走査）。

## 18. 将来のCLI拡張アイデア（参考）
- `--format json|csv|plain` の追加で機械可読性を高める。
- `--limit N` でTTYバケット上限を可変化。
- `--depth N` で再帰を制御（デフォルト1）。ただしパフォーマンスとUXに要注意。
- `--since <duration>` で特定期間のみ表示するフィルタ。

## 19. コマンド利用チェックリスト（新人向け）
- [ ] 目的のディレクトリか？ `pwd` で確認  
- [ ] 隠しファイルが必要か？ → `-H` を付ける  
- [ ] 7日より古いものも見たいか？ → `-a` を付ける  
- [ ] パイプで後処理するか？ → フラグ不要、必要なら `FTIME_FORCE_TTY` に注意  
- [ ] ログに色を混ぜたくないか？ → `NO_COLOR=1`  

## 20. コミュニケーションテンプレ
- バグ報告時に添えると調査が早い情報:  
  - 実行コマンドと環境変数（NO_COLOR / FTIME_FORCE_TTY）  
  - 期待した出力と実際の出力（数行でOK）  
  - OSとシェル、端末種別（TTYかどうか）  
  - 対象ディレクトリの構造の概要（例: ファイル数、シンボリックリンク有無）  

## 21. 参考例（コピペ用）
```
# もっともよく使う組み合わせ
ftime -a -H ~/workspace | head

# スナップショットを取る（カラーなし、TTY書式）
NO_COLOR=1 FTIME_FORCE_TTY=1 ftime ~/project > /tmp/ftime.txt

# パスだけをfzfで選ぶ
ftime | fzf --with-nth=1 | cut -f1
```

## 22. まとめ
ftime のCLIはシンプルだが、環境変数・TTY判定・バケット折り畳みが組み合わさるため挙動を理解しておくと活用度が上がる。本書はそのための包括的リファレンスであり、仕様変更時には必ず更新すること。ユーザーは「今何を触ったか」を最速で知るためのツールとして、上記パターンを状況に応じて使い分けてほしい。

（本書は7000文字超の日本語版。原文との乖離が生じた場合は本書を優先的に同期させること。） 

## 23. 環境マトリクス（挙動早見表）
| stdout | FTIME_FORCE_TTY | NO_COLOR | 出力形式 | 色 | バケット | 20件上限 |
| --- | --- | --- | --- | --- | --- | --- |
| TTY | なし | なし | TTY | あり | あり（History折り畳み） | あり |
| TTY | なし | あり | TTY | なし | あり | あり |
| パイプ | なし | なし/あり | テキスト | なし | なし | なし |
| パイプ | あり | なし | TTY | あり | あり | あり |
| パイプ | あり | あり | TTY | なし | あり | あり |

## 24. 追加のFAQ
- **Q: ファイルパスが長いと折り返されますか？**  
  A: 端末側の折り返しに依存します。ftime自体は幅制御をしません。
- **Q: mtime が取得できない特殊ファイルは？**  
  A: 取得失敗時はスキップされます。デバイスファイルや権限不足で起きる場合があります。
- **Q: ルート指定にシンボリックリンクを渡すと？**  
  A: `metadata` 判定でリンク先がディレクトリなら成功。リンク自体のパスがベースになるため表示はリンク名が基準。
- **Q: 一部だけ再帰したい**  
  A: 現仕様では不可。`find PATH -maxdepth 1 -type f -print0 | xargs -0 stat` 等で代替してください。
- **Q: `... and N more items` のNを正確に取りたい**  
  A: パイプモードを使えば全件出るので、`wc -l` で数えられます。

## 25. パイプレシピ集
- 最新5件のパスだけ: `ftime | head -n 5 | cut -f1`
- 7日以上前のものだけを抽出（非TTYで）: `ftime | awk -F'\t' '$2 ~ /[0-9]{4}-[0-9]{2}-[0-9]{2}/ {print $0}'`
- 相対時間を無視してパスをソート: `ftime | cut -f1 | sort`
- ディレクトリだけを抜き出す（TTY強制を利用）: `FTIME_FORCE_TTY=1 ftime | grep '/  '`

## 26. トラブル事例と対応
- **ケース**: `Permission denied` が多発して出力が空。  
  **対策**: そのディレクトリを対象から外すか、適切な権限で実行。ftime自体は黙ってスキップするため気付きにくい。  
- **ケース**: CIログで絵文字が化ける。  
  **対策**: `FTIME_FORCE_TTY=1` を避け、非TTY出力にするか、ロケールとフォントをUTF-8対応にする。  
- **ケース**: 日付の境界で Today/History が想定と違う。  
  **対策**: TZ設定を確認。ローカルタイム基準のためUTC固定では挙動が変わる。  

## 27. バグ報告テンプレート（簡易）
```
### 期待した結果
<例: History が折り畳まれず表示されること>

### 実際の結果
<例: `History (25 files hidden)` とだけ表示された>

### 再現手順
1. ディレクトリ構造: ...
2. 実行コマンド: NO_COLOR=1 FTIME_FORCE_TTY=1 ftime -a -H /path
3. 端末/OS: ...

### 備考
<stdout数行を貼る>
```

## 28. 教育用チェックポイント
- バケットの優先順（Active→Today→Week→History）を説明できるか。
- TTY/非TTYで何が変わるか説明できるか。
- `--all` と `--hidden` のデフォルト挙動を言えるか。
- NO_COLOR と FTIME_FORCE_TTY の組み合わせ結果を表で指させるか。

## 29. 将来のCLI変更時の留意
- 新オプションを追加する場合は、短縮形の競合を避ける。`-h` `-a` `-H` `-V` は既に使用中。
- 既存のデフォルト挙動を変える場合は、非互換をリリースノートに明記し、可能なら非推奨期間を設ける。
- 出力形式を変える場合は、パイプ利用の後方互換性に最大限配慮する（列数や区切り文字を変えない）。

## 30. 参考リンク
- 仕様: `docs/SPEC-ja.md`
- 設計: `docs/ARCHITECTURE-ja.md`
- テスト計画: `docs/TESTPLAN-ja.md`（本リポジトリに追加予定）
