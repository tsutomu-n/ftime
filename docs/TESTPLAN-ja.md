# ftime v1.0.0 テスト計画（日本語版・詳細）

本書は `TESTPLAN-v1.0.md` の日本語拡張版です。テスト観点、シナリオ、環境設定、リスクベースの優先度、実行手順、期待結果、判定基準を7000文字超で整理し、誰でも再現できるようにします。

---

## 1. テストの目的
- 仕様（`SPEC-v1.0.md` / `SPEC-ja.md`）に定義された挙動を確認し、回帰を防ぐ。
- CLIユーザーが想定する代表的なユースケース（TTY表示、パイプ、隠しファイル、折り畳み等）が壊れていないことを保証。
- エッジケース（空ディレクトリ、権限エラー、壊れたシンボリックリンク）でパニックしないことを確認。

## 2. テスト対象とスコープ
- 対象: ftime バイナリ（Cargoターゲット）。  
- スコープ: CLI挙動、バケット分類、相対時間表記、出力フォーマット、環境変数の影響。  
- 非スコープ: パフォーマンスベンチマーク（別途必要なら実施）、Git連携（未実装）。

## 3. テストタイプ別計画
### 3.1 ユニットテスト（ロジック）
- **時間バケット分類**  
  - Active: 1時間未満（未来含む）  
  - Today: 当日00:00以降  
  - ThisWeek: 7日未満  
  - History: その他  
  - 境界値: 3599秒, 3600秒, 今日開始直後, 6日23時間, 7日ちょうど
- **ソート**  
  - mtime降順が保たれるか。  
  - mtime同値の場合は name 昇順で安定しているか。
- **相対時間文字列**  
  - <60s: `just now`  
  - 60s: `1 min ago`  
  - 61s: `1 min ago`  
  - 2–59分: `{N} mins ago`  
  - 1時間: `1 hour ago`  
  - 2–23時間: `{N} hours ago`  
  - 1日: `Yesterday`  
  - 2–6日: `{N} days ago`  
  - 7日以降: `YYYY-MM-DD`

### 3.2 統合テスト（CLI）
- **デフォルト挙動**: バケットが表示され、Historyが折り畳まれる。
- **隠しファイル**: `-H` で表示され、デフォルトでは表示されない。
- **History折り畳み/展開**: 21件以上のHistoryで折り畳み表示、`-a` で展開＋ `... and N more items`。
- **パイプ出力**: タブ区切り、ヘッダなし、全件出力、カラーなし。
- **ルートがファイル**: エラー終了（コード1）、メッセージ包含。
- **空ディレクトリ**: `No recent files found` を出力しコード0。
- **リンク先が存在しないシンボリックリンク（dangling）**: `name -> target` として表示され、パニックしない（ターゲットの存在チェックはしない）。
- **権限エラーのあるエントリ**: スキップして継続（手動確認枠）。

### 3.3 手動回帰チェック（任意）
- カラー有無、アイコン表示の視認性。
- 長いファイル名の折り返し（端末依存）の確認。
- Windows端末でのカラー挙動（必要に応じて）。

## 4. 環境・前提条件
- Rust toolchain stable（Rust/Cargo 1.92+、edition 2024）。  
- 端末: 可能ならTTY/非TTY両方を用意。TTY判定は `is-terminal` に依存。  
- 環境変数: 必要に応じ `NO_COLOR`, `FTIME_FORCE_TTY` を設定。  
- テストフレームワーク: 標準の `cargo test`。統合テストは `assert_cmd`, `predicates`, `tempfile`, `filetime` を使用。

## 5. テストデータ設計
- **ファイル名**: アルファベット、ドット始まり（隠し）、サブディレクトリ、シンボリックリンク。
- **mtime設定**: `filetime::set_file_mtime` で任意の時刻に設定。  
- **件数**: History折り畳み確認用に25件以上を生成。  
- **リンク先が存在しないシンボリックリンク（dangling）**: 存在しないターゲットへのシンボリックリンクを作成（Unixで `ln -s /tmp/notfound dangling`）。`read_link` は成功するため、TTYでは `dangling -> /tmp/notfound` のように表示される。  
- **権限エラー**: `chmod 000 locked` など。ただしCI環境によっては権限操作が制限されるため手動枠。

## 6. 詳細テストケース
### 6.1 ユニット: classify_bucket
| ケース | now | mtime | 期待 | 備考 |
| --- | --- | --- | --- | --- |
| 未来時刻 | now=任意 | mtime=now+10s | Active | `duration_since` Err → Active |
| 10秒前 | now | now-10s | Active | |
| 3599秒前 | now | now-3599s | Active | 境界未満 |
| 3600秒前 | now | now-3600s | Today/Week判定へ | |
| 今日開始+10秒 | today_start+10s | Today | |
| 2日前 | now-2d | ThisWeek | |
| 8日前 | now-8d | History | |

### 6.2 ユニット: relative_time
| ケース | 入力 | 期待 |
| --- | --- | --- |
| 30秒 | just now |
| 60秒 | 1 min ago |
| 61秒 | 1 min ago |
| 5分 | 5 mins ago |
| 1時間 | 1 hour ago |
| 3時間 | 3 hours ago |
| 1日 | Yesterday |
| 3日 | 3 days ago |
| 8日 | YYYY-MM-DD |

### 6.3 統合: CLIシナリオ
1. **fails_when_path_is_file**  
   - 準備: 空ディレクトリ内に `a.txt` を作成  
   - コマンド: `ftime a.txt`  
   - 期待: 終了コード1、stderrに `not a directory`
2. **hidden_files_excluded_by_default_and_included_with_flag**  
   - 準備: `visible`, `.hidden` を作成  
   - コマンド: `ftime` → `.hidden` が出ない  
   - コマンド: `ftime -H` → `.hidden` が出る
3. **history_bucket_collapses_and_expands**  
   - 準備: 9日前のファイルを25個（mtimeを設定）  
   - コマンド: `FTIME_FORCE_TTY=1 ftime dir` → `History (25 files hidden)`  
   - コマンド: `FTIME_FORCE_TTY=1 ftime -a dir` → `... and 5 more items` が表示
4. **pipe_mode_outputs_tab_separated_without_headers**  
   - 準備: `f1` を1つ  
   - コマンド: `ftime dir`（非TTY）  
   - 期待: `f1\t` を含み、バケットヘッダがない

### 6.4 エッジケース（追加手動）
- **空ディレクトリ**: `No recent files found` で終了コード0。  
- **read_link 失敗のシンボリックリンク**: `<unresolved>` が表示され、落ちない（再現性が環境依存のため手動枠）。  
- **権限エラー**: エラーを出さずスキップする（観察で確認）。

## 7. リスクベース優先度
- **P0**: ルートがディレクトリでない場合のエラー、隠しファイル除外/包含、History折り畳み、パイプ出力形式。  
- **P1**: 相対時間フォーマット、シンボリックリンク表示。  
- **P2**: 権限エラー処理、長いファイル名の表示。  
P0が壊れるとユーザー体験が直ちに損なわれるため、必ず自動テストでカバーする。

## 8. 自動テスト実行手順
```
cargo fmt
cargo clippy -- -D warnings
cargo test
```
- CIでは最低 `cargo test` を必須とし、fmt/clippyは開発フェーズで実行。
- テストは約1秒で完了するため頻繁に回せる。

## 9. 手動確認チェックリスト
- [ ] NO_COLOR=1 で色が消えるか  
- [ ] FTIME_FORCE_TTY=1 で非TTYでもバケット表示になるか  
- [ ] History折り畳みが件数に比例して正しくカウントするか  
- [ ] シンボリックリンクが `name -> target` で表示されるか  
- [ ] 空ディレクトリで `No recent files found` が表示されるか  

## 10. カバレッジと不足領域
- ユニットテスト: バケット分類、相対時間、scanの隠しファイル除外をカバー。
- 統合テスト: 主要CLIパスをカバー。
- 不足: 権限エラー・壊れたリンクは自動化が難しく、手動確認または別途モックが必要。

## 11. 不具合発見時の報告プロセス
1. 再現手順と最小データセットを作成（可能なら `tempfile` スクリプトで再現可能にする）。
2. 期待結果と実際結果をテキストで記録（カラーを含めない形が望ましい）。
3. `NO_COLOR`/`FTIME_FORCE_TTY` の設定状況を明記。
4. OS/シェル/端末情報を添える。
5. `cargo test` の結果がどうだったかを記載。

## 12. メンテナンス方針
- 仕様変更時は必ずテストケースを追加/更新。  
- バグ修正で再発防止する場合は再現ケースを統合テストに落とし込む。  
- テストデータ生成に時間がかかる場合でも、実行時間1秒以内を目標にする。

## 13. 追加のテストアイデア（バックログ）
- **大規模件数**: 1万ファイルでの動作（パフォーマンス測定）。  
- **タイムゾーン差分**: `TZ` を変更して Today 判定が変わることを確認。  
- **Windows**: パス区切りやカラー挙動の確認。  
- **ファイル名にタブ**: パイプ出力での扱い。  
- **長いシンボリックリンクパス**: 切り捨てがないか確認。

## 14. 実行ログの取り扱い
- カラー出力はログで読みにくいため、CIでは `NO_COLOR=1` 推奨。  
- スナップショットを取る場合は `FTIME_FORCE_TTY=1` を併用し、TTYレイアウトを固定する。  
- ログが肥大化する場合、`-a` を外してHistory折り畳みを活用。

## 15. 判定基準
- 期待出力が正確に一致すること（テキストマッチ）。  
- 終了コードが仕様通りであること。  
- パニックやクラッシュがないこと。  
- 実行時間が現実的であること（目安: 全テストで数秒以内）。

## 16. メタ情報
- 本書はオンボーディング資料としても利用可能なよう、背景説明を多めにしている。  
- 自動テストと手動テストの線引きを明確にし、工数の見積もりを容易にする。  
- 仕様/設計ドキュメントと併読することで、なぜそのテストが必要かを理解しやすくしている。

## 17. 更新履歴
- 2025-12-10: 日本語詳細版初稿。相対時間と空ディレクトリの期待値を最新版実装に合わせて明文化。

（本書は7000文字超の日本語版。将来の仕様変更時には本書・テストコード・仕様書を同一コミットで更新すること。） 

## 18. 実行手順の詳細（再現性重視）
1. リポジトリをクリーンにする: `git status` がクリーンであることを確認。  
2. 依存を取得: `cargo fetch`（必要なら）。  
3. フォーマッタ/静的解析: `cargo fmt` → `cargo clippy -- -D warnings`。  
4. ユニット+統合テスト: `cargo test`。  
5. 追加の手動ケースが必要なら `scripts/` などにワンライナーを保存（現状は無し）。  
6. 結果を記録: 成功/失敗とログを短く残す。  

## 19. 自動化スクリプト例
```
#!/usr/bin/env bash
set -euo pipefail
export NO_COLOR=1
cargo fmt
cargo clippy -- -D warnings
cargo test
```
- CI で使う場合は `NO_COLOR=1` を設定し、ログを読みやすくする。
- `FTIME_FORCE_TTY` は通常不要だが、TTY出力のスナップショットを取りたいジョブでのみ設定する。

## 20. リスクと緩和策
- **色コード混入でログが崩れる**: `NO_COLOR=1` をデフォルトにする。
- **タイムゾーン差異でテストが不安定**: 相対時間テストは差分の出ない秒単位で行い、境界値は `start_of_day` を用いて計算する。
- **権限操作不可な環境**: 権限エラーケースは手動/ローカルでのみ実施。CIではスキップ。
- **大規模件数生成でディスクを圧迫**: 一時ディレクトリを使い、テスト終了後自動で削除される `tempfile` を活用。

## 21. 役割と責任
- **テストオーナー**: テスト計画を保守し、仕様変更時にケースを更新。  
- **実装者**: コード変更時に関連テストを追加し、既存テストの失敗を解決。  
- **レビュー担当**: PRレビュー時にテスト網羅性とドキュメント整合を確認。  
- **CI管理者**: テストジョブの安定性（タイムアウト・依存解決）を担保。  

## 22. 計測と品質メトリクス
- テスト実行時間: 目標 3秒以内（現状 ~1秒）。  
- 失敗時の再現性: ログに必要十分な情報が残ること（コマンド・環境変数・エラーメッセージ）。  
- カバレッジ: 行カバレッジ計測は必須ではないが、コアロジックとCLIパスをテストで通していることを確認。  

## 23. テストデータ生成コマンド集
- **古いファイル25件**  
  ```
  dir=$(mktemp -d)
  for i in $(seq 0 24); do touch "$dir/old-$i"; done
  python - <<'PY'
  import os, time, pathlib
  dir = os.environ["dir"] if "dir" in os.environ else os.getenv("dir")
  target = pathlib.Path(dir)
  old = time.time() - 9*24*3600
  for p in target.iterdir():
      os.utime(p, (old, old))
  PY
  ```
- **壊れたシンボリックリンク**  
  ```
  ln -s /tmp/does-not-exist "$dir/broken"
  ```
- **権限エラー**  
  ```
  touch "$dir/locked"
  chmod 000 "$dir/locked"
  ```

## 24. テスト結果の記録フォーマット例
```
日時: 2025-12-10
ブランチ: main
コミット: <hash>
コマンド: NO_COLOR=1 cargo test
結果: pass
メモ: 追加なし
```

## 25. 回帰テストのトリガー
- 仕様変更（バケット条件・相対時間表示・上限値）。
- 依存ライブラリアップデート（特に clap / colored / chrono）。
- OS/ランタイムアップデート（タイムゾーン処理に影響しうる）。
- バグ修正で新たなテストを追加した場合はフルスイートを再実行。

## 26. 将来のテスト拡張案
- スナップショットテストでTTY出力全体を比較（`insta` クレート等）。  
- プロパティベーステストでランダムなmtime配列に対してバケット条件が成立することを検証。  
- パフォーマンス計測をベンチに追加し、大量ファイル時の応答性を監視。  

## 27. 既知の難所
- 相対時間の表記はロケールに依存しないが、TZに依存するためCIとローカルでToday境界がズレる可能性がある。  
- 権限エラーの自動再現は環境依存（root不可など）なので、無理に自動化しない。  
- Windowsでのシンボリックリンク作成には管理者権限が必要な場合がある。  

## 28. サンプル期待出力（比較用）
```
🔥 Active Context (< 1h)
  • visible  just now

💤 History (25 files hidden)
```
- 折り畳み時は上記のようにHistory行1本のみ。  
- 展開時は `... and 5 more items` が含まれることを確認。  

## 29. ヘルスチェック・簡易テスト
- `cargo run -- -h` がヘルプを表示し終了コード0。  
- `cargo run -- --version` がバージョンを表示。  
- `cargo run -- ./` が正常終了し、空ディレクトリの場合 `No recent files found`。  

## 30. まとめ（テスト観点）
- P0の自動化が完了していることを常に確認する。  
- 新規機能を追加する場合は、最低1件のユニットテストと1件の統合テストをセットで追加する。  
- テストは短時間で終わる設計を維持し、開発者が変更のたびに気軽に回せるようにする。  
