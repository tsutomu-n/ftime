# ftime アーキテクチャ（日本語版・詳細）

本書は `docs/ARCHITECTURE.md` の日本語拡張版です。モジュール分割の意図、依存関係の選択理由、データフロー、失敗時の扱い、将来拡張の設計余地を具体的に記述します。実装・テスト・仕様との整合を最優先し、読み手がコードを開く前に全体像を掴めることを目的とします。

---

## 1. ゴールと設計原則
- **シンプル**: 深さ1の走査と最小限のオプションに限定し、バイナリサイズ・認知負荷を抑える。
- **安全**: パニックしない。権限エラーや壊れたリンクを無視して継続し、CLI全体の失敗を避ける。
- **可読性**: モジュール単位で責務を分け、将来のGit統合やフォーマット追加に備える。
- **テスト容易性**: `FTIME_FORCE_TTY` と `NO_COLOR` で出力を決定論的にし、スナップショットテストを簡単にする。

## 2. ディレクトリとモジュール構成
```
src/
├── main.rs          # エントリポイント、CLIパース、モード判定
├── engine.rs        # スキャン・ソート・バケット化のドメインロジック
├── model.rs         # ドメインデータ構造 (FileEntry, TimeBucket)
├── util/
│   └── time.rs      # 相対時間計算、バケット分類
└── view/
    ├── mod.rs       # （現状空）ビュー切替の将来拡張ポイント
    ├── tty.rs       # カラー/アイコン付きTTY表示
    └── text.rs      # プレーンテキスト（非TTY）
tests/               # 統合テスト（CLI挙動）
```

### モジュール責務
- **main.rs**: CLI引数のバリデーション、環境変数反映、I/Oエラーのトップレベルハンドリング。ビジネスロジックは呼び出すだけで持ち込まない。
- **engine.rs**: ファイルシステム読み取りとバケット分配の中核。I/O境界でエラーを握り潰す/伝搬する判断を集中させる。
- **model.rs**: 構造体定義のみ。依存が少なく、将来別バックエンド（Git）追加時に共通データモデルとして再利用可能。
- **util/time.rs**: 時刻処理の唯一の場所。DSTやローカルタイムへの依存をここに閉じ込め、他モジュールを純粋に保つ。
- **view/tty.rs & view/text.rs**: 表示責務を隔離し、レンダリングの違い（色・バケット折り畳み・リスト上限）のみを扱う。データ構造はエンジンから受け取る。

## 3. データモデル詳細
### FileEntry
- `path`: 絶対パス。表示時はベースディレクトリからの相対化を試みる。
- `name`: ファイル名文字列（`OsString`をロス許容で変換）。
- `is_dir`: ディレクトリ判定。
- `mtime`: `SystemTime`。ソート・バケット判定の唯一の基準。
- `is_symlink`: シンボリックリンクかどうか。
- `symlink_target`: `read_link` 成功時に保持するパス（任意）。未解決時は `None`。

### TimeBucket
- 列挙: `Active`, `Today`, `ThisWeek`, `History`。  
  実装ではローカルタイム境界を考慮し、評価順を固定することで意図しない重複を防ぐ。

## 4. 主要フロー
1. CLIパース（clap）
2. ルートパス検証 (`metadata` でディレクトリ確認)
3. 環境変数の反映（NO_COLOR / FTIME_FORCE_TTY）
4. `scan_dir` でエントリ取得
5. `bucketize` で分類
6. 出力先がTTYか、強制TTYかを判定
7. `view::tty::render` または `view::text::render` を呼び出し
8. エラー時は `anyhow::Error` を標準エラーへ表示し `exit(1)`

## 5. エラーハンドリング指針
- **致命的エラー（exit 1）**: ルートディレクトリが存在しない / ディレクトリでない、`read_dir` 不能など起動不能系。
- **非致命的エラー（スキップ）**: 各エントリでの `symlink_metadata` 失敗、`modified()` 取得失敗。結果精度に影響するがツール全体は継続。
- **パニック禁止**: unwrap/expectはテスト以外で使用しない（コードベースも遵守）。

## 6. パフォーマンス設計
- 深さ1限定でO(N log N)（Nは直下エントリ数）。Nが数千でも現実的時間で処理可能。
- `read_dir` を一度だけ呼び、必要なメタデータのみ取得。追加のstat呼び出しを避けるため symlink_metadata を利用。
- バケット表示上限20件によりTTY出力は常に小さく、人間のスキャンが容易。

## 7. 依存パッケージの理由
- `clap`（derive）: 宣言的なCLI定義とヘルプ自動生成。
- `colored`: 軽量なANSIカラー付加。`NO_COLOR` と併用しやすい。
- `chrono`: ローカルタイム境界計算と日付フォーマッタを安定提供。
- `is-terminal`: 安定したTTY判定。`std::io::IsTerminal` が安定したため将来的には置き換え可能。
- `anyhow`: 文脈付きエラーを簡潔に扱う。

## 8. ビュー層の詳細
### TTYビュー
- ヘッダー行＋箇条書き。行頭に2スペース＋中点記号でプレーンでも読める。
- バケットごとに空行を挿入し視認性を上げる。
- Historyはデフォルト折り畳みでノイズを減らす。

### テキストビュー
- タブ区切り2カラム。機械可読性を最優先。
- 文字列加工は最小限、色付けなし。`NO_COLOR` と無関係に常に無色。

## 9. テスト容易性を支える設計
- 出力内容の決定要素（TTY判定・環境変数・フラグ）を分離し、統合テストで環境変数セットを簡単にできる。
- `FTIME_FORCE_TTY` により、非TTY環境でもTTY書式を固定化した状態でテスト可能。
- 相対時間関数は `now` を引数に取り、テストでモック時刻を差し込める。

## 10. 将来拡張を想定したポイント
- **Git連携**: `FileEntry` に `git_status` を追加し、`engine` 側でワークツリーと組み合わせて取得。ビューで色分け。`model` の拡張だけで済むように分離。
- **複数出力フォーマット**: `view` 配下に `json.rs` `csv.rs` を追加し、`main` からフォーマットセレクタを渡す構造にする。
- **再帰走査**: `ScanOptions` に `max_depth` を追加し、BFSで拡張可能。ただしバケット表示や相対パス表示が煩雑になるため慎重に。

## 11. I/O とパス処理の詳細
- 表示時は `strip_prefix(base)` を試み、失敗した場合に元の名前を使う。これにより指定ディレクトリ外を指す壊れたリンクでもパニックしない。
- シンボリックリンクのターゲットは `read_link` 成功時のみ表示。解決に失敗した場合でもリンク自体はリストアップされる。
- 隠しファイル判定は文字列ベース（先頭`.`）。`..`は通常ファイルとして扱うが、`read_dir` に現れないため問題にならない。

## 12. ユースケース別シーケンス
### デフォルト（TTY）
1. `stdout.is_terminal()` → true  
2. `scan_dir` でエントリ取得、mtime降順ソート  
3. バケット化  
4. Active→Today→ThisWeek→Historyの順で表示、Historyは折り畳み  

### パイプ
1. `stdout.is_terminal()` → false  
2. `FTIME_FORCE_TTY` 未設定 → textビュー  
3. ソート済みエントリをタブ区切りで全件出力  

### 強制TTY
1. `FTIME_FORCE_TTY=1`  
2. 非TTYでもTTYビューを使い、色を付けたスナップショットを取れる  

## 13. スレッド・並列性について
v0.1では単スレッド。`read_dir` とソートのみでCPU負荷は低いため並列化は不要と判断。再帰対応時にはI/Oバウンドになるため Rayon 等の導入を再検討する。

## 14. ログと診断
- 標準動作でログ出力は行わない。静かなツールであることを優先。
- 失敗時は `anyhow` が付与するメッセージをstderrに1行で表示。
- デバッグ用途では今後 `--verbose` を導入する余地があるが、現行仕様では未実装。

## 15. セキュリティ・安全性
- ファイルを書き換えないため直接的な破壊リスクは低い。
- シンボリックリンクを追跡しないため、意図せぬネットワークマウント等へのアクセスを避けている。
- 隠しファイルをデフォルトで表示しないのは情報漏えい防止の一助。ただし `--hidden` で意図的に表示可能。

## 16. 国際化/I18N
- 出力メッセージとアイコンは英語ベース。ローカライズは行っていない。相対時間表記も英語。日本語環境でも同じ挙動。
- 将来ローカライズする場合は `view` 層でテキストテンプレートを差し替える形が最小変更となる。

## 17. ドキュメント間の関係
- 仕様: `SPEC-v0.1.md` / `SPEC-ja.md`
- 設計: 本書と `ARCHITECTURE.md`
- CLI契約: `CLI.md` / 将来 `CLI-ja.md`（本ファイルとは別）
- テスト: `TESTPLAN-v0.1.md`
これらを更新するときは一貫性を保つため最低でも仕様とテストを同一コミットで直すことを推奨。

## 18. 変更容易性を高めるパターン
- `ScanOptions` や `Bucketed` を拡張してもビューへの影響を最小化できるよう、構造体は公開フィールドでシリアライズ不要。
- 依存パッケージを絞り、アップデート時の破壊的変更を減らす。
- ファイル名処理を1箇所（ビュー）に限定し、I/O層では生のパスを持つ。

## 19. 参考コード断片（疑似Rust）
```rust
pub fn bucketize(entries: &[FileEntry], now: SystemTime) -> Bucketed {
    let mut out = Bucketed::default();
    for e in entries {
        match classify_bucket(now, e.mtime) {
            TimeBucket::Active => out.active.push(e.clone()),
            TimeBucket::Today => out.today.push(e.clone()),
            TimeBucket::ThisWeek => out.week.push(e.clone()),
            TimeBucket::History => out.history.push(e.clone()),
        }
    }
    out
}
```
責務が1関数1役割になっている点がコア設計思想。

## 20. 将来のアーキテクチャ上の論点
- **設定ファイルの導入可否**: 現状はフラグのみ。設定ファイルを導入すると起動オーバーヘッドと複雑性が増すため慎重。
- **プラグイン化**: ビューやフィルタをプラグインにする案はあるが、ロード機構の安全性・パフォーマンスが課題。
- **マルチルート表示**: 複数ディレクトリを同時に一覧したい要求はあるが、比較軸（mtime）が混在しUXが悪化するため現段階では採用していない。

## 21. メタ情報とメンテナンス
- この日本語版は解説を厚くし、チームオンボーディング用の教材としても活用できる。
- コードとの乖離を防ぐため、仕様変更やバグ修正のたびに該当節を更新すること。特にバケット条件・相対時間表記・上限値はテストと一緒に調整する。

## 22. 依存ライブラリの更新方針
- マイナーバージョンアップは `cargo update -p <crate>` で個別に実施し、`cargo test` を通す。
- メジャーアップデート時は Breaking Change を確認し、CLIヘルプや出力が変わっていないか手動で検証する。
- `colored` が非推奨になった場合の代替として `nu-ansi-term` を候補に挙げるが、`NO_COLOR` サポートが必須条件。
- `chrono` から `time` クレートへの移行を検討する場合、ローカルタイム変換やフォーマットAPIの差分に注意。

## 23. クロスプラットフォーム考慮
- Windows: ANSIカラー対応の端末が限定的。PowerShell/Windows Terminalでは概ね動作するが、旧cmd.exeでは色が出ない可能性。`NO_COLOR=1` を推奨。
- WSL/コンテナ: ホストとTZが異なると Today 判定がずれる。CIで一貫性を求めるなら `TZ=UTC` を環境に設定する。
- macOS: HFS+ のmtime精度は1秒。APFSではナノ秒だが本ツールは秒単位丸めのため問題なし。

## 24. シーケンス例（文字ベースの図解）
- **FTIME_FORCE_TTY + NO_COLOR**  
  1) env判定: force_tty=true, color=false  
  2) モード選択: TTYビュー  
  3) 出力: カラーコードなしのTTYフォーマット → スナップショットに最適  
- **隠しファイルだけのディレクトリ**  
  1) read_dirは要素を返すが `include_hidden=false` で全スキップ  
  2) entries.len() == 0 → `No recent files found`  
  3) exit code 0  
- **壊れたシンボリックリンク**  
  1) `symlink_metadata` OK, `read_link` 失敗  
  2) `symlink_target=None`  
  3) 表示時に `<unresolved>` と出力、エラーにならない

## 25. コードスタイルとレビュー観点
- `Result` で早期リターンし、`match` で特殊ケースを明示。例外系が分岐を埋もれさせないよう注意。
- テスト用以外で `unwrap/expect` を避け、`context` を付けて呼び出し元に情報を渡す。
- 関数サイズは短く保ち、ビューとロジックを混在させない。`engine` はデータ生成、`view` は表示のみ。

## 26. ロギング未採用の理由
- 単発CLIでログを混ぜるとパイプ処理が壊れるため、デフォルトは無ログ。将来 `--verbose` を追加する際も stderr に限定する。

## 27. セキュリティ・プライバシー詳細
- ファイル内容は読まないためデータ漏洩リスクは低い。ただしメタデータ（パス名）は露出するので、機密環境では隠しファイル表示に注意。
- シンボリックリンクを辿らないことで、意図しないネットワークマウントや巨大ファイルへのアクセスを防止。

## 28. トレーサビリティ
- 仕様→設計→実装→テストのリンクを意識して更新する。例: History折り畳み仕様変更なら SPEC/TESTPLAN/view/CLIテストを同一コミットで修正。

## 29. チーム分業モデル
- **エンジン担当**: scan_dir最適化、権限エラーの扱い改善、max_depth拡張検討。
- **ビュー担当**: カラーテーマ、ローカライズ、別フォーマット追加。
- **テスト担当**: スナップショット方針、境界ケースの網羅、CIジョブ整備。
- **ドキュメント担当**: 仕様・設計・CLI契約の同期、ユーザーガイド整備。

## 30. 今後のリファクタリング候補
- `view::mod` に trait を置き、各ビューが `render(entries, now, base, opts)` を実装する形へリファクタすると拡張容易。
- `engine::scan_dir` を返り値の型でフィルタ有無を明確化し、再帰対応時に拡張しやすくする。
- 相対時間関数を「丸め戦略」を引数化し、将来「1.4時間→1.5時間」表記などに切り替えやすくする。

## 22. まとめ
ftime は「直近作業の地図」を即座に提供するための最小構成CLIである。アーキテクチャはモジュールの責務を明確に分け、将来拡張に耐えるようシンプルかつ疎結合に保っている。利用者にとっては短い起動時間と読みやすい出力が価値であり、開発者にとってはテストしやすさと変更容易性が価値となる。

（本書は7000文字超の解説版。原文との差分が生じた場合は本書を更新し、最終的には両方を同期させること。） 
